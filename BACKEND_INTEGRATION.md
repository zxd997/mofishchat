# 前端后端集成说明

## 更新内容

已将聊天消息从前端内存存储迁移到后端数据库存储，实现数据持久化。

## 主要变更

### 1. 新增API服务

新增文件：`src/services/chatApi.js`
- 提供与后端通信的API接口
- 包含保存消息、获取历史消息等功能

### 2. 修改聊天存储逻辑

修改文件：`src/stores/chat.js`
- `addMessage` 函数现在会同时保存到本地和后端数据库
- 新增 `loadMessagesFromDatabase` 函数用于加载历史消息
- 添加消息类型转换函数

### 3. 修改聊天组件

修改文件：`src/components/chat/ChatArea.vue`
- 在组件初始化时先加载数据库中的历史消息
- 保持原有的WebSocket实时通信功能

## 功能特性

### ✅ 已实现功能

1. **消息持久化**：所有聊天消息都会保存到后端数据库
2. **历史消息加载**：页面刷新后会自动加载之前的聊天记录
3. **实时同步**：新消息会同时更新到本地和数据库
4. **兼容性**：保持原有的WebSocket实时通信功能不变
5. **错误处理**：即使数据库操作失败，前端界面仍正常工作

### 🔄 消息流程

1. **发送消息**：
   - 用户发送消息 → 通过WebSocket发送 → 服务器广播 → 前端接收并调用 `addMessage`
   - `addMessage` 函数会同时更新本地界面和保存到数据库

2. **加载历史**：
   - 页面初始化时调用 `loadMessagesFromDatabase`
   - 从后端API获取最近50条消息
   - 转换数据格式并显示在界面上

3. **数据格式转换**：
   - 前端消息类型：'text', 'system', 'robot'
   - 后端消息类型：0（用户消息）, 1（系统消息）, 2（机器人消息）

## 使用说明

### 前端启动

```bash
cd mofishchat
npm run dev
```

### 后端启动

```bash
cd mofishchat-backend
mvn spring-boot:run
```

### 验证集成

1. 启动后端服务（端口8081）
2. 启动前端服务（端口3000）
3. 打开浏览器访问前端页面
4. 发送几条消息
5. 刷新页面，验证消息是否持久化

## 注意事项

1. **后端依赖**：前端现在依赖后端服务，建议先启动后端
2. **数据库配置**：确保后端数据库配置正确
3. **跨域处理**：后端已配置允许跨域请求
4. **离线模式**：如果后端服务不可用，前端仍可在离线模式下工作（消息仅保存在内存中）

## 故障排除

### 问题1：页面无法加载历史消息
- 检查后端服务是否启动（http://localhost:8081/api/chat/health）
- 检查数据库连接是否正常
- 查看浏览器控制台错误信息

### 问题2：新消息无法保存到数据库
- 检查网络连接
- 查看后端日志输出
- 确认数据库表结构正确

### 问题3：WebSocket连接问题
- 这与后端数据库集成无关，检查WebSocket服务是否正常

## 技术细节

- **API基础URL**：`http://localhost:8081/api/chat`
- **数据传输格式**：JSON
- **错误处理**：API调用失败时会降级到本地模式
- **性能优化**：消息加载限制在最近50条，避免大量数据传输 